# Docker Compose for Single Server Deployment
# All services run in one Docker network, accessed via API Gateway
#
# Usage:
#   docker-compose -f docker-compose.single-server.yml up -d
#
# This deploys:
#   - API Gateway (port 8080) - Single entry point
#   - All 10 microservices on internal ports
#   - All services share the same database

version: '3.8'

services:
  # ============================================
  # API GATEWAY - Single Entry Point
  # ============================================
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - USER_SERVICE_URL=http://user-service:8081
      - PRODUCT_SERVICE_URL=http://product-service:8082
      - ORDER_SERVICE_URL=http://order-service:8083
      - PAYMENT_SERVICE_URL=http://payment-service:8084
      - CART_SERVICE_URL=http://cart-service:8085
      - NOTIFICATION_SERVICE_URL=http://notification-service:8086
      - MESSAGING_SERVICE_URL=http://messaging-service:8087
      - EMAIL_SERVICE_URL=http://email-service:8088
      - SEARCH_SERVICE_URL=http://search-service:8089
      - ADMIN_SERVICE_URL=http://admin-service:8090
    depends_on:
      - user-service
      - product-service
      - order-service
      - payment-service
      - cart-service
    networks:
      - b2b-network
    restart: unless-stopped

  # ============================================
  # MICROSERVICES
  # ============================================
  
  user-service:
    build:
      context: ./backend/user-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8081
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  product-service:
    build:
      context: ./backend/product-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8082
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  order-service:
    build:
      context: ./backend/order-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8083
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  payment-service:
    build:
      context: ./backend/payment-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8084
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  cart-service:
    build:
      context: ./backend/cart-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8085
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  notification-service:
    build:
      context: ./backend/notification-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8086
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  messaging-service:
    build:
      context: ./backend/messaging-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8087
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

  email-service:
    build:
      context: ./backend/email-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8088
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - SPRING_MAIL_HOST=${MAIL_HOST}
      - SPRING_MAIL_PORT=${MAIL_PORT}
      - SPRING_MAIL_USERNAME=${MAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD}
    networks:
      - b2b-network
    restart: unless-stopped

  search-service:
    build:
      context: ./backend/search-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8089
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - TYPESENSE_HOST=${TYPESENSE_HOST}
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY}
    networks:
      - b2b-network
    restart: unless-stopped

  admin-service:
    build:
      context: ./backend/admin-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8090
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - b2b-network
    restart: unless-stopped

networks:
  b2b-network:
    driver: bridge
