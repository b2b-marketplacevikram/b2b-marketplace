version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: b2b-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: b2b_marketplace
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./database/sample_data.sql:/docker-entrypoint-initdb.d/02-sample_data.sql
    networks:
      - b2b-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Apache Solr - Search Engine
  solr:
    image: solr:9.4
    container_name: b2b-solr
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr
      - ./solr-config:/opt/solr/server/solr/configsets/b2b_config/conf
    environment:
      SOLR_JAVA_MEM: "-Xms512m -Xmx512m"
    command:
      - solr-precreate
      - products
    networks:
      - b2b-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/admin/ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # User Service
  user-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: user-service
    container_name: b2b-user-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Product Service
  product-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: product-service
    container_name: b2b-product-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8082
    ports:
      - "8082:8082"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: order-service
    container_name: b2b-order-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8083
    ports:
      - "8083:8083"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: payment-service
    container_name: b2b-payment-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      SERVER_PORT: 8084
    ports:
      - "8084:8084"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Cart Service
  cart-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: cart-service
    container_name: b2b-cart-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8085
    ports:
      - "8085:8085"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: notification-service
    container_name: b2b-notification-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8086
    ports:
      - "8086:8086"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Email Service
  email-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: email-service
    container_name: b2b-email-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SPRING_MAIL_HOST: smtp.gmail.com
      SPRING_MAIL_PORT: 587
      SPRING_MAIL_USERNAME: ${EMAIL_USERNAME:-b2bmarketplace9@gmail.com}
      SPRING_MAIL_PASSWORD: ${EMAIL_PASSWORD}
      SERVER_PORT: 8087
    ports:
      - "8087:8087"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Admin Service
  admin-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: admin-service
    container_name: b2b-admin-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8088
    ports:
      - "8088:8088"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Search Service (Solr-based)
  search-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: search-service
    container_name: b2b-search-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SPRING_DATA_SOLR_HOST: http://solr:8983/solr
      SERVER_PORT: 8090
    ports:
      - "8090:8090"
    depends_on:
      mysql:
        condition: service_healthy
      solr:
        condition: service_started
    networks:
      - b2b-network

  # Messaging Service
  messaging-service:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        SERVICE_NAME: messaging-service
    container_name: b2b-messaging-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/b2b_marketplace
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      SERVER_PORT: 8091
    ports:
      - "8091:8091"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - b2b-network

  # Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_USER_SERVICE_URL: ${VITE_USER_SERVICE_URL:-http://localhost:8081/api}
        VITE_PRODUCT_SERVICE_URL: ${VITE_PRODUCT_SERVICE_URL:-http://localhost:8082/api}
        VITE_ORDER_SERVICE_URL: ${VITE_ORDER_SERVICE_URL:-http://localhost:8083/api}
        VITE_PAYMENT_SERVICE_URL: ${VITE_PAYMENT_SERVICE_URL:-http://localhost:8084/api}
        VITE_SEARCH_SERVICE_URL: ${VITE_SEARCH_SERVICE_URL:-http://localhost:8090/api}
        VITE_EMAIL_SERVICE_URL: ${VITE_EMAIL_SERVICE_URL:-http://localhost:8087/api}
        VITE_ADMIN_SERVICE_URL: ${VITE_ADMIN_SERVICE_URL:-http://localhost:8088/api}
    container_name: b2b-frontend
    ports:
      - "80:80"
    depends_on:
      - user-service
      - product-service
      - cart-service
      - search-service
    networks:
      - b2b-network

networks:
  b2b-network:
    driver: bridge

volumes:
  mysql_data:
  solr_data:
